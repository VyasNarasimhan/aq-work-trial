> SELECT u.username, ROUND(SUM(t.amount)::numeric, 2) as total_amount
> FROM users u
> JOIN transactions t ON u.user_id = t.user_id
> GROUP BY u.username
> ORDER BY total_amount DESC, u.username ASC
> LIMIT 10;
> """
>
> result = subprocess.run(
>     ['su', '-', 'postgres', '-c', f'psql -d production_db -t -A -F"," -c "{query}"'],
>     capture_output=True, text=True
> )
>
> lines = result.stdout.strip().split('\n')
>
> # Write to CSV
> with open('/backup/top_users.csv', 'w', newline='') as f:
>     writer = csv.writer(f)
>     writer.writerow(['username', 'total_amount'])
>     for line in lines:
>         if line:
>             writer.writerow(line.split(','))
>
> print(f'Top users report generated with {len(lines)} users')
> EOF
root@bbbc5313bf43:/backup# python3 /backup/generate_top_users.py; tmux wait -S done
Top users report generated with 10 users
root@bbbc5313bf43:/backup# cat /backup/top_users.csv; tmux wait -S done
username,total_amount
zara_ahmed,4400.17
alice_smith,3682.87
victor_von,3451.21
donna_noble,3225.49
xavier_prof,2990.51
nick_fury,2709.20
wade_wilson,2678.95
tony_stark,2637.00
frank_white,2539.97
charlie_brown,2525.32
root@bbbc5313bf43:/backup#
